<?php
// نمایش متن برای بررسی اجرا
echo "cron.php is running...<br>";

// بررسی اینکه آیا فایل آی‌پی وجود دارد
$ip_file = "latest_ip.txt";
if (!file_exists($ip_file)) {
    die("No IP recorded yet.");
}

// خواندن آی‌پی ذخیره‌شده
$ip = file_get_contents($ip_file);
$user_agent = "System Auto-Send";  
$timestamp = date("Y-m-d H:i:s");

// نمایش اطلاعات برای تست
echo "✅ Sending IP: $ip<br>";
echo "✅ Timestamp: $timestamp<br>";

// ارسال درخواست به Google Apps Script
$script_url = "https://script.google.com/macros/s/AKfycbznO-5cjuTd9dHcy28Ydg8UOoTLlwge_UTnecodggiL/dev";
$script_url .= "?ip=" . urlencode($ip) . "&ua=" . urlencode($user_agent) . "&timestamp=" . urlencode($timestamp);

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $script_url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false); // 🚀 **مهم: ابتدا ریدایرکت‌ها را دنبال نمی‌کنیم!**
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
$response = curl_exec($ch);
$http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$redirect_url = curl_getinfo($ch, CURLINFO_REDIRECT_URL); // گرفتن آدرس جدید در صورت ریدایرکت
$curl_error = curl_error($ch);
curl_close($ch);

// 🚀 **بررسی اینکه آیا `302` دریافت شده است؟**
if ($http_status == 302 && !empty($redirect_url)) {
    echo "⚠️ 302 Redirect detected! Following new URL: $redirect_url <br>";

    // **اجرای دوباره درخواست با URL جدید**
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $redirect_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $response = curl_exec($ch);
    $http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curl_error = curl_error($ch);
    curl_close($ch);
}

// نمایش پاسخ برای بررسی
echo "✅ Response: " . $response . "<br>";
echo "✅ HTTP Status: " . $http_status . "<br>";
echo "✅ CURL Error: " . $curl_error . "<br>";

// ذخیره لاگ برای بررسی
file_put_contents("cron_log.txt", "Sent IP: $ip at $timestamp | HTTP Status: $http_status | Response: $response | CURL Error: $curl_error\n", FILE_APPEND);
?>

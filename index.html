<?php
// Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¬Ø±Ø§
echo "cron.php is running...<br>";

// Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙØ§ÛŒÙ„ Ø¢ÛŒâ€ŒÙ¾ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
$ip_file = "latest_ip.txt";
if (!file_exists($ip_file)) {
    die("No IP recorded yet.");
}

// Ø®ÙˆØ§Ù†Ø¯Ù† Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡
$ip = file_get_contents($ip_file);
$user_agent = "System Auto-Send";  
$timestamp = date("Y-m-d H:i:s");

// Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ ØªØ³Øª
echo "âœ… Sending IP: $ip<br>";
echo "âœ… Timestamp: $timestamp<br>";

// Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Google Apps Script
$script_url = "https://script.google.com/macros/s/AKfycbznO-5cjuTd9dHcy28Ydg8UOoTLlwge_UTnecodggiL/dev";
$script_url .= "?ip=" . urlencode($ip) . "&ua=" . urlencode($user_agent) . "&timestamp=" . urlencode($timestamp);

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $script_url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false); // ğŸš€ **Ù…Ù‡Ù…: Ø§Ø¨ØªØ¯Ø§ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…!**
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
$response = curl_exec($ch);
$http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$redirect_url = curl_getinfo($ch, CURLINFO_REDIRECT_URL); // Ú¯Ø±ÙØªÙ† Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØµÙˆØ±Øª Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª
$curl_error = curl_error($ch);
curl_close($ch);

// ğŸš€ **Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ `302` Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ**
if ($http_status == 302 && !empty($redirect_url)) {
    echo "âš ï¸ 302 Redirect detected! Following new URL: $redirect_url <br>";

    // **Ø§Ø¬Ø±Ø§ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ URL Ø¬Ø¯ÛŒØ¯**
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $redirect_url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $response = curl_exec($ch);
    $http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curl_error = curl_error($ch);
    curl_close($ch);
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø® Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
echo "âœ… Response: " . $response . "<br>";
echo "âœ… HTTP Status: " . $http_status . "<br>";
echo "âœ… CURL Error: " . $curl_error . "<br>";

// Ø°Ø®ÛŒØ±Ù‡ Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
file_put_contents("cron_log.txt", "Sent IP: $ip at $timestamp | HTTP Status: $http_status | Response: $response | CURL Error: $curl_error\n", FILE_APPEND);
?>
